// =====================================================
// KAIRO - FINAL HYBRID SCHEMA (Frontend + AI Compatible)
// =====================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- ENUMS ---
enum Role {
  APPLICANT
  RECRUITER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum InternshipCategory {
  ENGINEERING
  DESIGN
  MARKETING
  SALES
  FINANCE
  HUMAN_RESOURCES
  OPERATIONS
  CONTENT_WRITING
  PRODUCT_MANAGEMENT
  DATA_SCIENCE
  SOFTWARE_DEVLOPMENT
  OTHER
}

enum InternshipType {
  ONSITE
  REMOTE
  HYBRID
}

enum InternshipMode {
  FULL_TIME
  PART_TIME
}

enum UserType {
  STUDENT
  GRADUATE
  PROFESSIONAL
  COMPANY
  ADMIN
}

enum InternshipStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum ApplicationStatus {
  Applied
  Shortlisted
  Interview
  Hire
  Reject
}

enum Stipendtype {
  PAID
  UNPAID
  PB    // Performance Based
  FIXED // Fixed Amount
}
enum InterviewMode{
  online
  offline
}

// --- MODELS ---

model User {
  id            String    @id @default(cuid())
  name          String?
  gender        Gender    @default(OTHER)
  email         String?   @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          Role      @default(APPLICANT)

  accounts      Account[]
  sessions      Session[]
  
  applicant     Applicant?
  recruiter     Recruiter?
  applications  InternshipApplication[]
}

// --- APPLICANT MODEL (The Critical Fix) ---
model Applicant {
  id            String  @id @default(cuid())
  userId        String  @unique
  
  // Profile Links
  linkedInLink  String?
  resumeLink    String?
  githubLink    String?
  portfolioLink String?
  
  about         String? @db.Text
  phoneNumber   String[]
  
  // --- LEGACY FIELDS (Keeps Frontend Happy) ---
  // These are simple arrays. Your current UI reads these.
  experience    Json?
  education     Json?
  skills        String[] 
  projects      String[] 

  // --- NEW AI FIELDS (Powering the Backend) ---
  // The Frontend ignores these for now, but Python writes to them.
  rawResumeText     String? @db.Text 
  resumeProjectText String? @db.Text
  
  // --- AI RELATIONS ---
  // We renamed these relations so they don't conflict with the arrays above.
  aiProjects     Project[] 
  verifiedSkills VerifiedSkill[] 

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- NEW TABLE: Project (Rich AI Data) ---
model Project {
  id               String  @id @default(cuid())
  title            String
  description      String? @db.Text
  githubUrl        String?  
  
  // AI Analysis Data
  projectLevel     String? // "Advanced", "Beginner"
  analysis         String? @db.Text
  codeQualityScore Float?  

  applicantId String
  applicant   Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)
}

// --- NEW TABLE: VerifiedSkill (Rich AI Data) ---
model VerifiedSkill {
  id                  String @id @default(cuid())
  skillName           String 
  skillNameNormalized String 
  masteryLevel        Float  

  applicantId String
  applicant   Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  @@unique([applicantId, skillNameNormalized])
}

// --- RECRUITER & COMPANY ---
model Recruiter {
  id           String  @id @default(cuid())
  userId       String  @unique
  companyId    String?
  position     String?
  website      String?
  contactEmail String?
  about        String? @db.Text

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  company      Company?     @relation(fields: [companyId], references: [id], onDelete: SetNull)
  internships  Internship[]
}

model Company {
  id          String      @id @default(cuid())
  name        String
  industry    String?
  website     String?
  description String?     @db.Text
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  recruiters  Recruiter[]
  internships Internship[]
}

// --- INTERNSHIP MODEL ---
model Internship {
  id                  String    @id @default(uuid())
  
  title               String
  slug                String    @unique
  description         String
  category            InternshipCategory?
  
  location            String
  type                InternshipType    @default(ONSITE)
  mode                InternshipMode    @default(FULL_TIME)
  durationWeeks       Int?
  startDate           DateTime?
  
  openings            Int?
  skillsRequired      String[]
  perks               String[]
  question            String[]
  eligibility         String?
  userType            UserType?
  
  stipend             Int?
  stipendType         Stipendtype?

  isActive            Boolean           @default(true)
  status              InternshipStatus  @default(DRAFT)
  applicationDeadline DateTime?
  viewsCount          Int               @default(0)
  applicationsCount   Int               @default(0)
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  companyId           String
  recruiterId         String
  company             Company                 @relation(fields: [companyId], references: [id])
  recruiter           Recruiter               @relation(fields: [recruiterId], references: [id])
  applications        InternshipApplication[]

  @@index([companyId])
  @@index([status])
  @@index([title])
}

// --- APPLICATION MODEL ---
model InternshipApplication {
  id                  String            @id @default(uuid())
  internshipId        String
  applicantId         String
  coverLetter         String?
  resumeUrl           String?
  resumeData          Json?
  isApplied           Boolean?          @default(true)
  isShortlisted       Boolean?
  selectInterview     Boolean?
  isHire              Boolean?
  isReject            Boolean?
  interviewMode       InterviewMode?    @default(online)
  interviewLocation   String?
  interviewDate       String?
  interviewTime       String?
  status              ApplicationStatus @default(Applied)
  createdAt           DateTime          @default(now())

  internship      Internship @relation(fields: [internshipId], references: [id])
  applicant       User       @relation(fields: [applicantId], references: [id])

  @@unique([internshipId, applicantId])
}

// --- AUTH MODELS ---
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  token      String   @id
  identifier String
  expires    DateTime
}